<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>OSGI</title><link rel="stylesheet" type="text/css" href="css/docbook.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"><style type="text/css">
body { background-image: url('images/draft-ribbon.png');
       background-repeat: no-repeat;
       background-position: top left;
       /* The following properties make the watermark "fixed" on the page. */
       /* I think that's just a bit too distracting for the reader... */
       /* background-attachment: fixed; */
       /* background-position: center center; */
     }</style><meta name="keywords" content="jetty, servlet-api, cometd, http, spdy, eclipse, maven, java, software"><link rel="home" href="index.html" title="Jetty : The Definitive Reference"><link rel="up" href="frameworks.html" title="Chapter&nbsp;26.&nbsp;Frameworks"><link rel="prev" href="frameworks.html" title="Chapter&nbsp;26.&nbsp;Frameworks"><link rel="next" href="optimizing.html" title="Chapter&nbsp;27.&nbsp;Optimizing Jetty"><link xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" rel="shortcut icon" href="images/favicon.ico"><script type="text/javascript" src="js/shCore.js"></script><script type="text/javascript" src="js/shBrushJava.js"></script><script type="text/javascript" src="js/shBrushXml.js"></script><script type="text/javascript" src="js/shBrushBash.js"></script><script type="text/javascript" src="js/shBrushJScript.js"></script><script type="text/javascript" src="js/shBrushProperties.js"></script><script type="text/javascript" src="js/shBrushPlain.js"></script><link type="text/css" rel="stylesheet" href="css/shCore.css"><link type="text/css" rel="stylesheet" href="css/shThemeEclipse.css"><link type="text/css" rel="stylesheet" href="css/font-awesome.min.css"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><table xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com"><tr><td style="width: 50%"><a href="http://www.eclipse.org/jetty"><img src="images/jetty-header-logo.png" alt="Jetty Logo"></a></td><td style="width: 50%"><script type="text/javascript">  (function() {
            var cx = '016459005284625897022:obd4lsai2ds';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
            })();
          </script><gcse:search></gcse:search></td></tr></table><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">OSGI</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="frameworks.html"><i class="icon-chevron-left"></i></a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;26.&nbsp;Frameworks</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="optimizing.html"><i class="icon-chevron-right"></i></a></td></tr></table><hr></div><div xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" class="jetty-callout"><h5 class="callout"><a href="http://www.webtide.com/support.jsp">Contact the core Jetty developers at
          <span class="website">www.webtide.com</span></a></h5><p>
 private support for your internal/customer projects ... custom extensions and distributions ... versioned snapshots for indefinite support ...
 scalability guidance for your apps and Ajax/Comet projects ... development services from 1 day to full product delivery
      </p></div><div xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" class="draft"><h5>DRAFT</h5><p>
          This page contains content that we have migrated from Jetty 7 or Jetty 8 documentation into the correct format, but we have not yet audited it for technical accuracy in Jetty 9.  Be aware that examples or information contained on this page may be incorrect.  Please check back soon as we continue improving the documentation, or submit corrections yourself to this page through <a href="http://github.com/jetty-project/jetty-documentation" style="text-decoration:none"><i class="icon-github"></i> Github</a>. Thank you.
          </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="framework-jetty-osgi"></a>OSGI</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="framework-jetty-osgi.html#d0e13898">Introduction</a></span></dt><dt><span class="section"><a href="framework-jetty-osgi.html#d0e13903">General Setup</a></span></dt><dt><span class="section"><a href="framework-jetty-osgi.html#d0e13964">The Jetty OSGi Container</a></span></dt><dt><span class="section"><a href="framework-jetty-osgi.html#d0e14098">Deploying Bundles as Webapps</a></span></dt><dt><span class="section"><a href="framework-jetty-osgi.html#d0e14167">Deploying Bundles as Jetty ContextHandlers</a></span></dt><dt><span class="section"><a href="framework-jetty-osgi.html#services-as-webapps">Deploying Services as Webapps</a></span></dt><dt><span class="section"><a href="framework-jetty-osgi.html#d0e14314">Deploying Services as ContextHandlers</a></span></dt><dt><span class="section"><a href="framework-jetty-osgi.html#d0e14368">Support for the OSGi Service Platform Enterprise
    Specification</a></span></dt><dt><span class="section"><a href="framework-jetty-osgi.html#d0e14454">Using JSPs</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13898"></a>Introduction</h3></div></div></div><p>The Jetty OSGi infrastructure provides a Jetty container inside an
    OSGi container. Traditional JavaEE webapps can be deployed, in addition to
    Jetty ContextHandlers, along with OSGi web bundles. In addition, the
    infrastructure also supports the OSGi HttpService interface.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13903"></a>General Setup</h3></div></div></div><p>All of the Jetty jars contain manifest entries appropriate to ensure
    that they can be deployed into an OSGi container as bundles. You will need
    to install some jetty jars into your OSGi container. You can always find
    the jetty jars either in the maven central repository, or you can download
    a distribution of jetty. Here's the minimal set:</p><div class="table"><a name="d0e13908"></a><p class="title"><b>Table&nbsp;26.1.&nbsp;Bundle Name Mapping</b></p><div class="table-contents"><table summary="Bundle Name Mapping" border="1"><colgroup><col><col></colgroup><thead><tr><th>Jar</th><th>Bundle Symbolic Name</th></tr></thead><tbody><tr><td>jetty-util</td><td>org.eclipse.jetty.util</td></tr><tr><td>jetty-http</td><td>org.eclipse.jetty.http</td></tr><tr><td>jetty-io</td><td>org.eclipse.jetty.io</td></tr><tr><td>jetty-security</td><td>org.eclipse.jetty.security</td></tr><tr><td>jetty-server</td><td>org.eclipse.jetty.server</td></tr><tr><td>jetty-servlet</td><td>org.eclipse.jetty.servlet</td></tr><tr><td>jetty-webapp</td><td>org.eclipse.jetty.webapp</td></tr><tr><td>jetty-deploy</td><td>org.eclipse.jetty.deploy</td></tr><tr><td>jetty-xml</td><td>org.eclipse.jetty.xml</td></tr></tbody></table></div></div><br class="table-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13964"></a>The Jetty OSGi Container</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13967"></a>The jetty-osgi-boot jar</h4></div></div></div><p>Now that you have the basic set of Jetty jars installed, you can
      install the <a class="link" href="http://repo1.maven.org/maven2/org/eclipse/jetty/osgi/jetty-osgi-boot/" target="_top">jetty-osgi-boot.jar</a>
      bundle, downloadable from the maven central repo <a class="link" href="http://repo1.maven.org/maven2/org/eclipse/jetty/osgi/jetty-osgi-boot/" target="_top">here.</a></p><p>This bundle will instantiate and make available the Jetty OSGi
      container.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="customize-jetty-container"></a>Customizing the Jetty Container</h4></div></div></div><p>Before going ahead with the install, you may want to customize the
      Jetty container. In general this is done by a combination of System
      properties and the usual jetty xml configuration files. The way you
      define the System properties will depend on which OSGi container you are
      using, so ensure that you are familiar with how to set them for your
      environment. In the following examples, we will assume that the OSGi
      container allows us to set System properties as simple name=value
      pairs.</p><p>The available System properties are:</p><div class="variablelist"><dl><dt><span class="term">jetty.port</span></dt><dd><p>If not specified, this defaults to the usual jetty port of
            8080.</p></dd><dt><span class="term">jetty.home</span></dt><dd><p>Either this property <span class="emphasis"><em>or</em></span> the <span class="bold"><strong>jetty.home.bundle</strong></span> <span class="emphasis"><em>must</em></span>
            be specified. This property should point to a file system location
            that has an <code class="code">etc/</code> directory containing xml files to
            configure the Jetty container on startup. For example:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[
                jetty.home=/opt/custom/jetty
              ]]>
        </script></div><p>Where <code class="code">/opt/custom/jetty</code> contains:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[

etc/jetty.xml
etc/jetty-selector.xml
etc/jetty-deployer.xml
etc/jetty-special.xml

              ]]>
        </script></div></dd><dt><span class="term">jetty.home.bundle</span></dt><dd><p>Either this property <span class="emphasis"><em>or</em></span> the <span class="bold"><strong>jetty.home</strong></span> property must be specified. This
            property should specify the symbolic name of a bundle which
            contains a directory called <code class="code">jettyhome/</code>. The<code class="code">
            jettyhome/</code> directory should have a subdirectory called
            <code class="code">etc/</code> that contains the xml files to be applied to
            Jetty on startup. The jetty-osgi-boot.jar contains a<code class="code">
            jettyhome/</code> directory with a default set of xml
            configuration files. Here's how you would specify it:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[jetty.home.bundle=org.eclipse.jetty.osgi.boot]]>
        </script></div><p>Here's a partial listing of that jar that shows you the
            names of the xml files contained within it:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[META-INF/MANIFEST.MF
jettyhome/etc/jetty.xml
jettyhome/etc/jetty-deployer.xml
jettyhome/etc/webdefault.xml
jettyhome/etc/jetty-selector.xml]]>
        </script></div></dd><dt><span class="term">jetty.etc.config.urls</span></dt><dd><p>This specifies the paths of the xml files - relative to
            <span class="bold"><strong>jetty.home</strong></span> or <span class="bold"><strong>jetty.home.bundle</strong></span>/jettyhome - that are to
            be used. If not specified, they default to:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[etc/jetty.xml,etc/jetty-selector.xml,etc/jetty-deployer.xml]]>
        </script></div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e14069"></a>The Jetty Container as an OSGi Service</h4></div></div></div><p>You can now go ahead and deploy the jetty-osgi-boot.jar into your
      OSGi container. A Jetty Server instance will be created, the xml config
      files applied to it, and then published as an OSGi service. Normally,
      you will not need to interact with this service instance, however you
      can retrieve a reference to it using the usual OSGi api:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: java;toolbar: false">
          <![CDATA[

org.osgi.framework.BundleContext bc;
org.osgi.framework.ServiceReference ref = bc.getServiceReference("org.eclipse.jetty.server.Server");

        ]]>
        </script></div><p>The Server service has a couple of properties associated with it
      that you can retrieve using the
      org.osgi.framework.ServiceReference.getProperty(String) method:</p><div class="variablelist"><dl><dt><span class="term">managedServerName</span></dt><dd><p>The Jetty Server instance created by the jetty-osgi-boot.jar
            will be called "defaultJettyServer"</p></dd><dt><span class="term">jetty.etc.config.urls</span></dt><dd><p>The list of xml files resolved from either <span class="bold"><strong>jetty.home</strong></span> or<span class="bold"><strong>
            jetty.home.bundle</strong></span>/jettyhome</p></dd></dl></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14098"></a>Deploying Bundles as Webapps</h3></div></div></div><p>The Jetty OSGi container listens for the installation of bundles,
    and will automatically attempt to deploy any that appear to be
    webapps.</p><p>Any of the following criteria are sufficient for Jetty to deploy the
    bundle as a webapp:</p><div class="variablelist"><dl><dt><span class="term">Bundle contains a WEB-INF/web.xml file</span></dt><dd><p>If the bundle contains a web descriptor, then it is
          automatically deployed. This is an easy way to deploy classic JavaEE
          webapps.</p></dd><dt><span class="term">Bundle MANIFEST contains Jetty-WarFolderPath</span></dt><dd><p>This is the location within the bundle of the webapp
          resources. Typically this would be used if the bundle is not a pure
          webapp, but rather the webapp is a component of the bundle. Here's
          an example of a bundle where the resources of the webapp are not
          located at the root of the bundle, but rather inside the
          subdirectory <code class="code">web/</code> :</p><p><code class="code">MANIFEST</code>:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[

Bundle-Name: Web
Jetty-WarFolderPath: web
Import-Package: javax.servlet;version="2.6.0",
 javax.servlet.resources;version="2.6.0"
Bundle-SymbolicName: com.acme.sample.web

            ]]>
        </script></div><p>Bundle contents:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[

META-INF/MANIFEST.MF
web/index.html
web/foo.html
web/WEB-INF/web.xml
com/acme/sample/web/MyStuff.class
com/acme/sample/web/MyOtherStuff.class

            ]]>
        </script></div></dd><dt><span class="term">Bundle MANIFEST contains Web-ContextPath</span></dt><dd><p>This header can be used in conjunction with either of the two
          preceding headers to control the context path to which the webapp is
          deployed, or alone to identify that the bundle's contents should be
          published as a webapp. This header is part of the RFC-66
          specification for using webapps with OSGi. Here's an eample based on
          the previous one where we use the Web-ContextPath header to set its
          deployment context path to be "/sample" :</p><p><code class="code">MANIFEST</code>:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[

Bundle-Name: Web
Jetty-WarFolderPath: web
Web-ContextPath: /sample
Import-Package: javax.servlet;version="2.6.0",
 javax.servlet.resources;version="2.6.0"
Bundle-SymbolicName: com.acme.sample.web

            ]]>
        </script></div></dd></dl></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e14146"></a>Determining the Context Path for a Webapp Bundle</h4></div></div></div><p>As we have seen in the previous section, if the bundle
      <code class="code">MANIFEST</code> contains the RFC-66 header <span class="bold"><strong>Web-ContextPath</strong></span>, Jetty will use that as the
      context path. If the MANIFEST does not contain that header, then Jetty
      will concoct a context path based on the last element of the bundle's
      location (by calling Bundle.getLocation()) after stripping off any file
      extensions.</p><p>For example, suppose we have a bundle whose location is:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false; gutter: false">
          <![CDATA[file://some/where/over/the/rainbow/oz.war]]>
        </script></div><p>The corresponding synthesized context path would be:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false; gutter: false">
          <![CDATA[/oz]]>
        </script></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14167"></a>Deploying Bundles as Jetty ContextHandlers</h3></div></div></div><p>In addition to deploying webapps, the Jetty OSGi container listens
    for the installation of bundles that are not heavyweight webapps, but
    rather use the flexible Jetty-specific concept of ContextHandlers.</p><p>The following is the criteria used to decide if a bundle can be
    deployed as a ContextHandler:</p><div class="variablelist"><dl><dt><span class="term">Bundle MANIFEST contains Jetty-ContextFilePath</span></dt><dd><p>A comma separated list of names of context files - each one of
          which represents a ContextHandler that should be deployed by Jetty.
          The context files can be inside the bundle, external to the bundle
          somewhere on the file system, or external to the bundle in the
          <span class="bold"><strong>jetty.home</strong></span> directory.</p><p>A context file that is inside the bundle:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[Jetty-ContextFilePath: ./a/b/c/d/foo.xml]]>
        </script></div><p>A context file that is on the file system:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[Jetty-ContextFilePath: /opt/app/contexts/foo.xml]]>
        </script></div><p>A context file that is relative to jetty.home:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[Jetty-ContextFilePath: contexts/foo.xml]]>
        </script></div><p>A number of different context files:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[Jetty-ContextFilePath: ./a/b/c/d/foo.xml,/opt/app/contexts/foo.xml,contexts/foo.xml]]>
        </script></div></dd></dl></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e14204"></a>Determining the Context Path for a ContextHandler Bundle</h4></div></div></div><p>Usually, the context path for the ContextHandler will be set by
      the context xml file. However, you can override any path set in the
      context xml file by using the <span class="bold"><strong>Web-ContextPath</strong></span> header in the
      <code class="code">MANIFEST</code>.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e14215"></a>Extra Properties Available for Context Xml Files</h4></div></div></div><p>Before the Jetty OSGi container applies a context xml file found
      in a Jetty-ContextFilePath MANIFEST header, it sets a few useful
      properties that can be referred to within the xml file:</p><div class="variablelist"><dl><dt><span class="term">Server</span></dt><dd><p>This is a reference to the Jetty
            org.eclipse.jetty.server.Server instance to which the
            ContextHandler being configured in the context xml file will be
            deployed.</p></dd><dt><span class="term">bundle.root</span></dt><dd><p>This is a reference to the
            org.eclipse.jetty.util.resource.Resource that represents the
            location of the Bundle (obtained by calling Bundle.getLocation()).
            Note that this could be either a directory in the file system if
            the OSGi container automatically unpacks bundles, or it may be a
            jar:file: url if the bundle remains packed.</p></dd></dl></div><p>Here's an example of a context xml file that makes use of these
      properties:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: xml;toolbar: false">
          <![CDATA[<?xml version="1.0"  encoding="ISO-8859-1"?>
<!DOCTYPE Configure PUBLIC "-//Jetty//Configure//EN" "http://www.eclipse.org/jetty/configure.dtd">

<Configure class="org.eclipse.jetty.server.handler.ContextHandler">

  <!-- Get root for static content, could be on file system or this bundle -->
  <Call id="res" class="org.eclipse.jetty.util.resource.Resource" name="newResource">
    <Arg><Property name="bundle.root"/></Arg>
  </Call>

  <Ref id="res">
    <Call id="base" name="addPath">
      <Arg>/static/</Arg>
    </Call>
  </Ref>

  <Set name="contextPath">/unset</Set>

  <!-- Set up the base resource for static files relative to inside bundle -->
  <Set name="baseResource">
     <Ref id="base"/>
  </Set>

  <Set name="handler">
    <New class="org.eclipse.jetty.server.handler.ResourceHandler">
      <Set name="welcomeFiles">
        <Array type="String">
          <Item>index.html</Item>
        </Array>
      </Set>
      <Set name="cacheControl">max-age=3600,public</Set>
    </New>
  </Set>

</Configure>

]]>
        </script></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="services-as-webapps"></a>Deploying Services as Webapps</h3></div></div></div><p>In addition to listening for bundles whose format or
    <code class="code">MANIFEST</code> entries define a webapp or ContextHandler for to be
    deployed, the Jetty OSGi container also listens for the registration of
    OSGi services that are instances of
    org.eclipse.jetty.webapp.WebAppContext. So you may programmatically create
    a WebAppContext, register it as a service, and have Jetty pick it up and
    deploy it.</p><p>Here's an example of doing that with a simple bundle that serves
    static content, and an org.osgi.framework.BundleActivator that
    instantiates the WebAppContext:</p><p>The bundle contents:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[

META-INF/MANIFEST.MF
index.html
com/acme/osgi/Activator.class

      ]]>
        </script></div><p>The <code class="code">MANIFEST.MF</code>:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[

Bundle-Classpath: .
Bundle-Name: Jetty OSGi Test WebApp
DynamicImport-Package: org.eclipse.jetty.*;version="[9.0,10.0)"
Bundle-Activator: com.acme.osgi.Activator
Import-Package: org.eclipse.jetty.server.handler;version="[9.0,10)",
 org.eclipse.jetty.webapp;version="[9.0,10)",
 org.osgi.framework;version= "[1.5,2)",
 org.osgi.service.cm;version="1.2.0",
 org.osgi.service.packag eadmin;version="[1.2,2)",
 org.osgi.service.startlevel;version="1.0.0",
 org.osgi.service.url;version="1.0.0",
 org.osgi.util.tracker;version= "1.3.0",
 org.xml.sax,org.xml.sax.helpers
Bundle-SymbolicName: com.acme.testwebapp

      ]]>
        </script></div><p>The Activator code:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: java;toolbar: false">
          <![CDATA[

public void start(BundleContext context) throws Exception
{
    WebAppContext webapp = new WebAppContext();
    Dictionary props = new Hashtable();
    props.put("Jetty-WarFolderPath",".");
    props.put("contextPath","/acme");
    context.registerService(ContextHandler.class.getName(),webapp,props);
}

      ]]>
        </script></div><p>The above setup is sufficient for Jetty to recognize and deploy the
    WebAppContext at /acme.</p><p>As the example shows, you can use OSGi Service properties in order
    to communicate extra configuration information to Jetty:</p><div class="variablelist"><dl><dt><span class="term">Jetty-WarFolderPath</span></dt><dd><p>The location within the bundle of the root of the static
          resources for the webapp</p></dd><dt><span class="term">Web-ContextPath</span></dt><dd><p>The context path at which to deploy the webapp.</p></dd><dt><span class="term">Jetty-defaultWebXmlFilePath</span></dt><dd><p>The location within the bundle of a webdefault.xml file to
          apply to the webapp. Defaults to that of the Jetty OSGi
          container.</p></dd><dt><span class="term">Jetty-WebXmlFilePath</span></dt><dd><p>The location within the bundle of the web.xml file. Defaults
          to WEB-INF/web.xml</p></dd><dt><span class="term">Jetty-extraClassPath</span></dt><dd><p>A classpath of additional items to add to the webapp's
          classloader.</p></dd><dt><span class="term">Jetty-bundleInstall</span></dt><dd><p>The path to the base folder that overrides the computed bundle
          installation - mostly useful for those OSGi frameworks that unpack
          bundles by default.</p></dd><dt><span class="term">Require-TldBundle</span></dt><dd><p>A comma separated list of bundle symbolic names of bundles
          containing TLDs that this webapp depends upon.</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14314"></a>Deploying Services as ContextHandlers</h3></div></div></div><p>Similarly to WebAppContexts, the Jetty OSGi container can detect the
    registration of an OSGi Service that represents a ContextHandler and
    ensure that it is deployed. The ContextHandler can either be fully
    configured before it is registered as an OSGi service - in which case the
    Jetty OSGi container will merely deploy it - or the ContextHandler can be
    partially configured, with the Jetty OSGi container completing the
    configuration via a context xml file and properties associated with the
    Service.</p><p>Here's an example of doing that with a simple bundle that serves
    static content with an org.osgi.framework.BundleActivator that
    instantiates a ContextHandler and registers it as an OSGi Service, passing
    in properties that define a context xml file and context path for Jetty to
    apply upon deployment:</p><p>The bundle contents:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[

META-INF/MANIFEST.MF
static/index.html
acme.xml
com/acme/osgi/Activator.class
com/acme/osgi/Activator$1.class

      ]]>
        </script></div><p>The <code class="code">MANIFEST</code>:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[

Bundle-Classpath: .
Bundle-Name: Jetty OSGi Test Context
DynamicImport-Package: org.eclipse.jetty.*;version="[9.0,10.0)"
Bundle-Activator: com.acme.osgi.Activator
Import-Package: javax.servlet;version="2.6.0",
 javax.servlet.resources;version="2.6.0",
 org.eclipse.jetty.server.handler;version="[9.0,10)",
 org.osgi.framework;version="[1.5,2)",
 org.osgi.service.cm;version="1.2.0",
 org.osgi.service.packageadmin;version="[1.2,2)",
 org.osgi.service.startlevel;version="1.0.0.o",
 org.osgi.service.url;version="1.0.0",
 org.osgi.util.tracker;version="1.3.0",
 org.xml.sax,org.xml.sax.helpers
Bundle-SymbolicName: com.acme.testcontext

      ]]>
        </script></div><p>The Activator code:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: java;toolbar: false">
          <![CDATA[

public void start(final BundleContext context) throws Exception
{
    ContextHandler ch = new ContextHandler();
    ch.addEventListener(new ServletContextListener () {

            @Override
            public void contextInitialized(ServletContextEvent sce)
            {
               System.err.println("Context is initialized");
            }

            @Override
            public void contextDestroyed(ServletContextEvent sce)
            {
                System.err.println("Context is destroyed!");                
            }
            
    });
    Dictionary props = new Hashtable();
    props.put("Web-ContextPath","/acme");
    props.put("Jetty-ContextFilePath", "acme.xml");
    context.registerService(ContextHandler.class.getName(),ch,props);
}

      ]]>
        </script></div><p>The contents of the <code class="code">acme.xml</code> context file:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: xml;toolbar: false">
          <![CDATA[<?xml version="1.0"  encoding="ISO-8859-1"?>
<!DOCTYPE Configure PUBLIC "-//Jetty//Configure//EN" "http://www.eclipse.org/jetty/configure.dtd">

<Configure class="org.eclipse.jetty.server.handler.ContextHandler">

  <!-- Get root for static content, could be on file system or this bundle -->
  <Call id="res" class="org.eclipse.jetty.util.resource.Resource" name="newResource">
    <Arg><Property name="bundle.root"/></Arg>
  </Call>

  <Ref id="res">
    <Call id="base" name="addPath">
      <Arg>/static/</Arg>
    </Call>
  </Ref>

  <Set name="contextPath">/unset</Set>

  <!-- Set up the base resource for static files relative to inside bundle -->
  <Set name="baseResource">
     <Ref id="base"/>
  </Set>

  <Set name="handler">
    <New class="org.eclipse.jetty.server.handler.ResourceHandler">
      <Set name="welcomeFiles">
        <Array type="String">
          <Item>index.html</Item>
        </Array>
      </Set>
      <Set name="cacheControl">max-age=3600,public</Set>
    </New>
  </Set>

</Configure>

]]>
        </script></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e14348"></a>Extra Properties Available for Context Xml Files</h4></div></div></div><p>Before the Jetty OSGi container applies a context xml file found
      in a Jetty-ContextFilePath property, it sets a few useful properties
      that can be referred to within the xml file:</p><div class="variablelist"><dl><dt><span class="term">Server</span></dt><dd><p>This is a reference to the Jetty
            org.eclipse.jetty.server.Server instance to which the
            ContextHandler being configured in the context xml file will be
            deployed.</p></dd><dt><span class="term">bundle.root</span></dt><dd><p>This is a reference to the
            org.eclipse.jetty.util.resource.Resource that represents the
            location of the Bundle publishing the ContextHandler as a
            Service(obtained by calling Bundle.getLocation()). Note that this
            could be either a directory in the file system if the OSGi
            container automatically unpacks bundles, or it may be a jar:file:
            url if the bundle remains packed.</p></dd></dl></div><p>In the example above, you can see both of these properties being
      used in the context xml file.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14368"></a>Support for the OSGi Service Platform Enterprise
    Specification</h3></div></div></div><p>The Jetty OSGi container implements several aspects of the
    Enterprise Specification v4.2 for the WebAppContexts and ContextHandlers
    that it deploys from either bundles or OSGi services as outlined in
    foregoing sections.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e14373"></a>Context Attributes</h4></div></div></div><p>For each WebAppContext or ContextHandler, the following context
      attribute is set, as required by section<span class="emphasis"><em> 128.6.1 Bundle
      Context</em></span> pg 427:</p><div class="variablelist"><dl><dt><span class="term">osgi-bundleContext</span></dt><dd><p>The value of this attribute is the BundleContext
            representing the Bundle associated with the WebAppContext or
            ContextHandler.</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e14388"></a>Service Attributes</h4></div></div></div><p>As required by the specification section <span class="emphasis"><em>128.3.4
      Publishing the Servlet Context</em></span> pg 421, each WebAppContext and
      ContextHandler deployed by the Jetty OSGi container is also published as
      an OSGi service (unless it has been already - see sections 1.6 and 1.7).
      The following properties are associated with these services:</p><div class="variablelist"><dl><dt><span class="term">osgi.web.symbolicname</span></dt><dd><p>The symbolic name of the Bundle associated with the
            WebAppContext or ContextHandler</p></dd><dt><span class="term">osgi.web.version</span></dt><dd><p>The Bundle-Version header from the Bundle associated with
            the WebAppContext or ContextHandler</p></dd><dt><span class="term">osgi.web.contextpath</span></dt><dd><p>The context path of the WebAppContext or
            ContextHandler</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e14415"></a>OSGi Events</h4></div></div></div><p>As required by the specification section <span class="emphasis"><em>128.5
      Events</em></span> pg 426, the following OSGi Event Admin events will be
      posted:</p><div class="variablelist"><dl><dt><span class="term">org/osgi/service/web/DEPLOYING</span></dt><dd><p>The Jetty OSGi container is about to deploy a WebAppContext
            or ContextHandler</p></dd><dt><span class="term">org/osgi/service/web/DEPLOYED</span></dt><dd><p>The Jetty OSGi container has finished deploying a
            WebAppContext or ContextHandler and it is in service</p></dd><dt><span class="term">org/osgi/service/web/UNDEPLOYING</span></dt><dd><p>The Jetty OSGi container is about to undeploy a
            WebAppContext or ContextHandler</p></dd><dt><span class="term">org/osgi/service/web/UNDEPLOYED</span></dt><dd><p>The Jetty OSGi container has finished undeploying a
            WebAppContext or ContextHandler and it is no longer in
            service</p></dd><dt><span class="term">org/osgi/service/web/FAILED</span></dt><dd><p>The Jetty OSGi container failed to deploy a WebAppContext or
            ContextHandler</p></dd></dl></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14454"></a>Using JSPs</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e14457"></a>Setup</h4></div></div></div><p>In order to use JSPs with your webapps and bundles you will need
      to install the JSP related jars into your OSGi container. You can use
      the jars from the <a class="link" href="http://repo1.maven.org/maven2/org/eclipse/jetty/jetty-distribution/" target="_top">jetty
      distribution</a> in the $JETTY_HOME/lib/jsp directory, or you can
      download them from <a class="link" href="http://repo1.maven.org/maven2/org/eclipse/jetty/orbit/" target="_top">maven
      central</a>. Here is the list of recommended jars (NOTE the version
      numbers may change in future):</p><div class="table"><a name="d0e14468"></a><p class="title"><b>Table&nbsp;26.2.&nbsp;Jars Required for JSP</b></p><div class="table-contents"><table summary="Jars Required for JSP" border="1"><colgroup><col><col></colgroup><thead><tr><th>Jar</th><th>Bundle Symbolic Name</th></tr></thead><tbody><tr><td>com.sun.el-2.2.0.v201303151357.jar</td><td>com.sun.el</td></tr><tr><td>javax.el-2.2.0.v201303151357.jar</td><td>javax.el</td></tr><tr><td>javax.servlet.jsp-2.2.0.v201112011158.jar</td><td>javax.servlet.jsp</td></tr><tr><td>javax.servlet.jsp.jstl-1.2.0.v201105211821.jar</td><td>javax.servlet.jsp.jstl</td></tr><tr><td>org.apache.jasper.glassfish-2.2.2.v201112011158.jar</td><td>org.apache.jasper.glassfish</td></tr><tr><td>org.apache.taglibs.standard.glassfish-1.2.0.v201112081803.jar</td><td>org.apache.taglibs.standard.glassfish</td></tr><tr><td>org.eclipse.jdt.core-3.8.2.v20130121.jar</td><td>org.eclipse.jdt.core.compiler.batch</td></tr></tbody></table></div></div><br class="table-break"></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="d0e14514"></a>The jetty-osgi-boot-jsp jar</h4></div></div></div><p>To be able to use JSPs you will need to also install the <a class="link" href="http://repo1.maven.org/maven2/org/eclipse/jetty/osgi/jetty-osgi-boot-jsp/" target="_top">jetty-osgi-boot-jsp.jar</a>
      into your OSGi container. This jar can be obtained from maven central
      <a class="link" href="http://repo1.maven.org/maven2/org/eclipse/jetty/osgi/jetty-osgi-boot-jsp/" target="_top">here</a>.</p><p>This bundle acts as a fragment extension to the
      jetty-osgi-boot.jar and adds in support for using JSP. If you do not use
      taglibs, or you only use the JSTL taglibs then you do not need to do any
      further configuration.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="d0e14527"></a>Using TagLibs</h5></div></div></div><p>The Jetty JSP OSGi container will make available the JSTL tag
        library to all webapps. If you only use this tag library, then your
        webapp will work without any further modification.</p><p>However, if you make use of other taglibs, you will need to
        ensure that they are installed into the OSGi container, and also
        define some System properties and/or MANIFEST headers in your webapp.
        This is necessary because the classloading regime used by the OSGi
        container is very different than that used by JSP containers, and the
        MANIFEST of a normal webapp does not contain enough information for
        the OSGi environment to allow a JSP container to find and resolve TLDs
        referenced in the webapp's .jsp files.</p><p>Firstly, lets look at an example of a web bundle's modified
        MANIFEST file so you get an idea of what is required. This example is
        a web bundle that uses the Spring servlet framework:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false; highlight: [4, 5]">
          <![CDATA[

Bundle-SymbolicName: com.acme.sample
Bundle-Name: WebSample
Web-ContextPath: taglibs
Import-Bundle: org.springframework.web.servlet
Require-TldBundle: org.springframework.web.servlet
Bundle-Version: 1.0.0
Import-Package: org.eclipse.virgo.web.dm;version="[3.0.0,4.0.0)",org.s
 pringframework.context.config;version="[2.5.6,4.0.0)",org.springframe
 work.stereotype;version="[2.5.6,4.0.0)",org.springframework.web.bind.
 annotation;version="[2.5.6,4.0.0)",org.springframework.web.context;ve
 rsion="[2.5.6,4.0.0)",org.springframework.web.servlet;version="[2.5.6
 ,4.0.0)",org.springframework.web.servlet.view;version="[2.5.6,4.0.0)"
 
          ]]>
        </script></div><p>The <span class="bold"><strong>Require-TldBundle</strong></span> header
        tells the Jetty OSGi container that this bundle contains TLDs that
        need to be passed over to the JSP container for processing. The
        <span class="bold"><strong>Import-Bundle</strong></span> header ensures that the
        implementation classes for these TLDs will be available to the webapp
        on the OSGi classpath.</p><p>The format of the <span class="bold"><strong>Require-TldBundle</strong></span> header is a comma separated
        list of one or more symbolic names of bundles containing TLDs.</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="d0e14552"></a>Container Path Taglibs</h5></div></div></div><p>Some TLD jars are required to be found on the Jetty OSGi
        container's classpath, rather than considered part of the web bundle's
        classpath. For example, this is true of JSTL and Java Server Faces.
        The Jetty OSGi container takes care of JSTL for you, but you can
        control which other jars are considered as part of the container's
        classpath by using the System property <span class="bold"><strong>org.eclipse.jetty.osgi.tldbundles</strong></span>:</p><div class="variablelist"><dl><dt><span class="term">org.eclipse.jetty.osgi.tldbundles</span></dt><dd><p>System property defined on the OSGi environment that is a
              comma separated list of symbolic names of bundles containing
              taglibs that will be treated as if they are on the container's
              classpath for web bundles. For example:</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: plain;toolbar: false">
          <![CDATA[org.eclipse.jetty.osgi.tldbundles=com.acme.special.tags,com.foo.web,org.bar.web.framework]]>
        </script></div><p>You will still need to define the <span class="bold"><strong>Import-Bundle</strong></span> header in the MANIFEST file
              for the web bundle to ensure that the TLD bundles are on the
              OSGi classpath.</p></dd></dl></div><p>Alternatively or additionally, you can define a pattern as a
        context attribute that will match symbolic bundle names in the OSGi
        environment containing TLDs that should be considered as discovered
        from the container's classpath.</p><div class="variablelist"><dl><dt><span class="term">org.eclipse.jetty.server.webapp.containerIncludeBundlePattern</span></dt><dd><p>This pattern must be specified as a context attribute of
              the WebAppContext representing the web bundle. Unless you are
              deploying your own WebAppContext (see <a class="link" href="framework-jetty-osgi.html#services-as-webapps" title="Deploying Services as Webapps">Deploying Services as
              Webapps</a>), you won't have a reference to the WebAppContext
              to do this. In that case, it can be specified on the
              org.eclipse.jetty.deploy.DeploymentManager, where it will be
              applied to <span class="emphasis"><em>every</em></span> webapp deployed by the
              Jetty OSGi container. The jetty-osgi-boot.jar contains the
              default jettyhome/etc/jetty-deploy.xml file where the
              DeploymentManager is defined. To set the pattern, you will need
              to provide your own etc files - see the section on <a class="link" href="framework-jetty-osgi.html#customize-jetty-container" title="Customizing the Jetty Container">customizing the jetty
              container</a> for how to do this. Here's how the
              jetty-deploy.xml file would look if we defined a pattern that
              matched all bundle symbolic names ending in "tag" and
              "web":</p><div class="informalexample"><script type="syntaxhighlighter" class="brush: xml;toolbar: false">
          <![CDATA[

<?xml version="1.0"?>
<!DOCTYPE Configure PUBLIC "-//Jetty//Configure//EN" "http://www.eclipse.org/jetty/configure_9_0.dtd">
<Configure id="Server" class="org.eclipse.jetty.server.Server">
    <Call name="addBean">
      <Arg>
        <New id="DeploymentManager" class="org.eclipse.jetty.deploy.DeploymentManager">
          <Set name="contexts">
            <Ref refid="Contexts" />
          </Set>
          <Call name="setContextAttribute">
            <Arg>org.eclipse.jetty.server.webapp.ContainerIncludeBundlePattern</Arg>
            <Arg>.*\.tag$|.*\.web$</Arg>
          </Call>
        </New>
      </Arg>
    </Call>
</Configure>

                ]]>
        </script></div><p>Again, you will still need to define suitable <span class="bold"><strong>Import-Bundle</strong></span> headers in your web bundle
              MANIFEST to ensure that bundles matching the pattern are
              available on the OSGi class path.</p></dd></dl></div></div></div></div></div><script type="text/javascript">
      SyntaxHighlighter.all()
    </script><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="frameworks.html"><i class="icon-chevron-left"></i></a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="frameworks.html"><i class="icon-chevron-up"></i></a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="optimizing.html"><i class="icon-chevron-right"></i></a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;26.&nbsp;Frameworks&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html"><i class="icon-home"></i></a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;27.&nbsp;Optimizing Jetty</td></tr></table></div><div xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" class="jetty-callout"><p>
        See an error or something missing?
        <span class="callout"><a href="http://github.com/jetty-project/jetty-documentation">Contribute to this documentation at
            <span class="website"><i class="icon-github"></i> Github!</span></a></span></p></div><script xmlns:jfetch="java:org.eclipse.jetty.xslt.tools.JavaSourceFetchExtension" xmlns:fetch="java:org.eclipse.jetty.xslt.tools.SourceFetchExtension" xmlns:d="http://docbook.org/ns/docbook" xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0" xmlns:xslthl="http://xslthl.sf.net" xmlns:gcse="http://www.google.com" type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1149868-7']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
    </script></body></html>